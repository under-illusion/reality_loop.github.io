<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI视觉机械臂控制系统</title>
  
  <!-- 外部依赖 -->
  <script src="https://unpkg.com/event-source-polyfill@1.0.20/eventsource.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.3.0/marked.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css">
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      height: 100vh;
      overflow: hidden;
    }

    .app-container {
      display: flex;
      height: 100vh;
      position: relative;
    }

    /* 主聊天区域 */
    .main-chat {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(10px);
    }

    /* 顶部标题栏 */
    .chat-header {
      padding: 20px;
      border-bottom: 1px solid rgba(0, 0, 0, 0.1);
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: rgba(255, 255, 255, 0.95);
    }

    .chat-title h1 {
      font-size: 24px;
      color: #2c3e50;
      margin-bottom: 4px;
    }

    .chat-subtitle {
      color: #7f8c8d;
      font-size: 14px;
    }

    .header-actions {
      display: flex;
      gap: 10px;
    }

    .icon-btn {
      background: rgba(0, 0, 0, 0.1);
      border: none;
      padding: 10px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .icon-btn:hover {
      background: rgba(0, 0, 0, 0.2);
      transform: translateY(-1px);
    }

    .icon-btn.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    /* 聊天消息区域 */
    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      scroll-behavior: smooth;
    }

    .welcome-message {
      text-align: center;
      padding: 40px 20px;
      color: #7f8c8d;
    }

    .welcome-content h2 {
      color: #2c3e50;
      margin-bottom: 20px;
    }

    .welcome-content ul {
      text-align: left;
      max-width: 400px;
      margin: 20px auto;
    }

    .welcome-content li {
      margin-bottom: 10px;
    }

    /* 消息样式 */
    .message {
      margin-bottom: 20px;
    }

    .message.user {
      text-align: right;
    }

    .message-content {
      display: inline-block;
      max-width: 80%;
      padding: 12px 16px;
      border-radius: 18px;
      word-wrap: break-word;
    }

    .message.user .message-content {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .message.assistant .message-content {
      background: rgba(0, 0, 0, 0.05);
      color: #2c3e50;
    }

    /* AI思考过程（像ChatGPT样式） */
    .thinking-section {
      margin: 16px 0;
      border: 1px solid rgba(0, 0, 0, 0.1);
      border-radius: 12px;
      overflow: hidden;
      background: rgba(248, 249, 250, 0.8);
    }

    .thinking-header {
      padding: 12px 16px;
      background: rgba(0, 0, 0, 0.02);
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      user-select: none;
      transition: background 0.2s ease;
    }

    .thinking-header:hover {
      background: rgba(0, 0, 0, 0.05);
    }

    .thinking-title {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      font-weight: 500;
      color: #666;
    }

    .thinking-toggle {
      width: 16px;
      height: 16px;
      transition: transform 0.2s ease;
    }

    .thinking-toggle.expanded {
      transform: rotate(180deg);
    }

    .thinking-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease, padding 0.3s ease;
      padding: 0 16px;
    }

    .thinking-content.expanded {
      max-height: 500px;
      padding: 16px;
    }

    .thinking-text {
      font-size: 13px;
      line-height: 1.5;
      color: #555;
      font-family: 'Monaco', 'Consolas', monospace;
      white-space: pre-wrap;
    }

    /* 语音唤醒状态 */
    .voice-wake-indicator {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(46, 213, 115, 0.9);
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
      display: none;
      z-index: 1000;
      animation: pulse 1s infinite;
    }

    .voice-wake-indicator.active {
      display: block;
    }

    /* 视觉系统侧边面板 */
    .vision-panel {
      width: 0;
      height: 100vh;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-left: 1px solid rgba(0, 0, 0, 0.1);
      transition: width 0.3s ease;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      box-shadow: -5px 0 20px rgba(0, 0, 0, 0.1);
    }

    .vision-panel.open {
      width: 40%;
    }

    .vision-header {
      padding: 20px;
      border-bottom: 1px solid rgba(0, 0, 0, 0.1);
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: rgba(255, 255, 255, 0.9);
    }

    .vision-title {
      font-size: 18px;
      font-weight: 600;
      color: #2c3e50;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .close-vision-btn {
      background: rgba(0, 0, 0, 0.1);
      border: none;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }

    .close-vision-btn:hover {
      background: rgba(0, 0, 0, 0.2);
      transform: scale(1.1);
    }

    .vision-body {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
    }

    .camera-container {
      margin-bottom: 20px;
    }

    .camera-view, .detection-view {
      position: relative;
      margin-bottom: 15px;
      border-radius: 12px;
      overflow: hidden;
      background: rgba(0, 0, 0, 0.05);
      aspect-ratio: 16/9;
    }

    .camera-view img, .detection-view img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .camera-overlay, .detection-overlay {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
    }

    .vision-controls {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 20px;
    }

    .control-btn {
      padding: 12px 16px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 500;
      transition: all 0.2s ease;
    }

    .control-btn.primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .control-btn.secondary {
      background: rgba(0, 0, 0, 0.1);
      color: #2c3e50;
    }

    .control-btn:hover {
      transform: translateY(-1px);
    }

    .objects-list {
      background: rgba(0, 0, 0, 0.02);
      border-radius: 8px;
      padding: 15px;
      min-height: 100px;
    }

    .empty-state {
      text-align: center;
      color: #7f8c8d;
      font-style: italic;
    }

    /* 视觉面板切换按钮 */
    .vision-toggle-btn {
      position: fixed;
      top: 50%;
      right: 20px;
      transform: translateY(-50%);
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 50;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      transition: all 0.3s ease;
    }

    .vision-toggle-btn:hover {
      transform: translateY(-50%) scale(1.1);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
    }

    .vision-toggle-btn.panel-open {
      right: 420px;
    }

    /* 执行确认区域 */
    .execution-panel {
      padding: 15px 20px;
      background: rgba(255, 193, 7, 0.1);
      border-top: 1px solid rgba(255, 193, 7, 0.3);
      border-bottom: 1px solid rgba(255, 193, 7, 0.3);
    }

    .execution-content {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 20px;
    }

    .execution-actions {
      display: flex;
      gap: 10px;
    }

    .exec-btn {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      font-weight: 500;
      transition: all 0.2s ease;
    }

    .exec-btn.confirm {
      background: #28a745;
      color: white;
    }

    .exec-btn.cancel {
      background: #dc3545;
      color: white;
    }

    .exec-btn:hover {
      transform: translateY(-1px);
    }

    /* 底部输入区域 */
    .chat-input-area {
      padding: 20px;
      border-top: 1px solid rgba(0, 0, 0, 0.1);
      background: rgba(255, 255, 255, 0.95);
    }

    .input-mode-tabs {
      display: flex;
      gap: 5px;
      margin-bottom: 15px;
      align-items: center;
    }

    .mode-tab {
      padding: 8px 16px;
      border: 1px solid rgba(0, 0, 0, 0.2);
      background: white;
      border-radius: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 14px;
      transition: all 0.2s ease;
    }

    .mode-tab.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-color: transparent;
    }

    .mode-tab:hover:not(.active) {
      background: rgba(0, 0, 0, 0.05);
    }

    /* 语音设置 */
    .voice-settings {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-left: auto;
    }

    .setting-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .setting-label {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 14px;
      color: #666;
    }

    .toggle-switch {
      position: relative;
      width: 44px;
      height: 24px;
      background: #ddd;
      border-radius: 12px;
      cursor: pointer;
      transition: background 0.3s ease;
    }

    .toggle-switch.active {
      background: #667eea;
    }

    .toggle-switch::after {
      content: '';
      position: absolute;
      top: 2px;
      left: 2px;
      width: 20px;
      height: 20px;
      background: white;
      border-radius: 50%;
      transition: transform 0.3s ease;
    }

    .toggle-switch.active::after {
      transform: translateX(20px);
    }

    .input-wrapper {
      display: flex;
      gap: 10px;
      align-items: flex-end;
      position: relative;
    }

    #message_input {
      flex: 1;
      padding: 12px 50px 12px 16px;
      border: 1px solid rgba(0, 0, 0, 0.2);
      border-radius: 20px;
      resize: none;
      font-family: inherit;
      font-size: 14px;
      max-height: 120px;
      min-height: 44px;
    }

    #message_input:focus {
      outline: none;
      border-color: #667eea;
    }

    .voice-btn {
      position: absolute;
      right: 60px;
      bottom: 6px;
      background: none;
      border: none;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      color: #7f8c8d;
    }

    .voice-btn:hover {
      background: rgba(0, 0, 0, 0.1);
      color: #2c3e50;
    }

    .voice-btn.recording {
      background: #ff4757;
      color: white;
      animation: pulse 1s infinite;
    }

    .voice-btn.listening {
      background: #2ed573;
      color: white;
      animation: pulse 1s infinite;
    }

    .send-btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      width: 44px;
      height: 44px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }

    .send-btn:hover {
      transform: scale(1.05);
    }

    .send-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    /* 音频控制 */
    .audio-status {
      position: absolute;
      bottom: -25px;
      left: 0;
      font-size: 12px;
      color: #7f8c8d;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .audio-status.visible {
      opacity: 1;
    }

    /* 通知样式 */
    #notifications {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
    }

    .notification {
      background: rgba(255, 255, 255, 0.95);
      border-left: 4px solid #667eea;
      padding: 15px 20px;
      border-radius: 8px;
      margin-bottom: 10px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      backdrop-filter: blur(10px);
      animation: slideIn 0.3s ease;
    }

    .notification.success {
      border-left-color: #2ed573;
    }

    .notification.warning {
      border-left-color: #ff9f43;
    }

    .notification.error {
      border-left-color: #ff4757;
    }

    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    /* 响应式设计 */
    @media (max-width: 768px) {
      .vision-panel.open {
        width: 100vw;
        position: fixed;
        top: 0;
        right: 0;
        z-index: 100;
      }

      .vision-toggle-btn.panel-open {
        right: 20px;
      }

      .voice-settings {
        flex-direction: column;
        gap: 10px;
        margin-left: 0;
      }

      .input-mode-tabs {
        flex-wrap: wrap;
      }
    }

    /* 加载动画 */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(0, 0, 0, 0.1);
      border-radius: 50%;
      border-top-color: #667eea;
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- 语音唤醒指示器 -->
    <div class="voice-wake-indicator" id="voice_wake_indicator">
      🎤 语音唤醒激活中...
    </div>

    <!-- 主聊天区域 -->
    <main class="main-chat">
      <!-- 顶部标题栏 -->
      <header class="chat-header">
        <div class="chat-title">
          <h1>🤖 AI视觉机械臂助手</h1>
          <div class="chat-subtitle" id="system_status">正在连接...</div>
        </div>
        <div class="header-actions">
          <button class="icon-btn" onclick="toggleVisionPanel()" title="视觉系统">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
              <circle cx="12" cy="12" r="3"/>
            </svg>
          </button>
        </div>
      </header>

      <!-- 聊天消息区域 -->
      <div class="chat-messages" id="chat_messages">
        <div class="welcome-message">
          <div class="welcome-content">
            <h2>👋 欢迎使用AI视觉机械臂控制系统</h2>
            <p>您可以通过以下方式与我交流：</p>
            <ul>
              <li>💬 <strong>文本输入</strong>：直接输入指令</li>
              <li>🎤 <strong>语音输入</strong>：点击麦克风按钮录音或开启语音唤醒</li>
              <li>👁️ <strong>视觉分析</strong>：基于摄像头画面进行分析</li>
            </ul>
            <p>例如：<code>"请帮我抓取桌上的红色苹果"</code></p>
          </div>
        </div>
      </div>

      <!-- 执行确认区域 -->
      <div class="execution-panel" id="execution_panel" style="display: none;">
        <div class="execution-content">
          <div class="execution-info" id="execution_info"></div>
          <div class="execution-actions">
            <button class="exec-btn confirm" onclick="confirmExecution()">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 12l2 2 4-4"/>
                <path d="M21 12c0 4.97-4.03 9-9 9s-9-4.03-9-9 4.03-9 9-9 9 4.03 9 9z"/>
              </svg>
              执行动作
            </button>
            <button class="exec-btn cancel" onclick="cancelExecution()">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="18" y1="6" x2="6" y2="18"/>
                <line x1="6" y1="6" x2="18" y2="18"/>
              </svg>
              取消
            </button>
          </div>
        </div>
      </div>

      <!-- 底部输入区域 -->
      <footer class="chat-input-area">
        <!-- 输入模式选择和语音设置 -->
        <div class="input-mode-tabs">
          <button class="mode-tab active" data-mode="text" onclick="switchInputMode('text')">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
              <polyline points="14,2 14,8 20,8"/>
              <line x1="16" y1="13" x2="8" y2="13"/>
              <line x1="16" y1="17" x2="8" y2="17"/>
              <polyline points="10,9 9,9 8,9"/>
            </svg>
            文本
          </button>
          <button class="mode-tab" data-mode="voice" onclick="switchInputMode('voice')">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
              <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
              <line x1="12" y1="19" x2="12" y2="23"/>
              <line x1="8" y1="23" x2="16" y2="23"/>
            </svg>
            语音
          </button>
          
          <!-- 语音设置 -->
          <div class="voice-settings">
            <div class="setting-item">
              <div class="setting-label">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
                  <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
                  <line x1="12" y1="19" x2="12" y2="23"/>
                  <line x1="8" y1="23" x2="16" y2="23"/>
                </svg>
                <span>语音唤醒</span>
              </div>
              <div class="toggle-switch" id="voice_wake_toggle" onclick="toggleVoiceWake()"></div>
            </div>
            <div class="setting-item">
              <div class="setting-label">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/>
                  <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"/>
                </svg>
                <span>语音播放</span>
              </div>
              <div class="toggle-switch active" id="tts_toggle" onclick="toggleTTS()"></div>
            </div>
          </div>
        </div>

        <!-- 输入区域 -->
        <div class="input-wrapper">
          <textarea 
            id="message_input" 
            placeholder="请输入您的指令或问题..." 
            rows="1"
          ></textarea>
          
          <!-- 语音按钮 -->
          <button class="voice-btn" id="voice_btn" onclick="toggleVoiceRecording()" title="点击录音">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
              <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
              <line x1="12" y1="19" x2="12" y2="23"/>
              <line x1="8" y1="23" x2="16" y2="23"/>
            </svg>
          </button>
          
          <button class="send-btn" onclick="sendMessage()" id="send_btn">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="22" y1="2" x2="11" y2="13"/>
              <polygon points="22,2 15,22 11,13 2,9 22,2"/>
            </svg>
          </button>
          
          <div class="audio-status" id="audio_status"></div>
        </div>
      </footer>
    </main>

    <!-- 视觉系统侧边面板 -->
    <div class="vision-panel" id="vision_panel">
      <div class="vision-header">
        <div class="vision-title">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
            <circle cx="12" cy="12" r="3"/>
          </svg>
          视觉系统
        </div>
        <button class="close-vision-btn" onclick="toggleVisionPanel()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
          </svg>
        </button>
      </div>

      <div class="vision-body">
        <div class="camera-container">
          <div class="camera-view">
            <img id="live_camera" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='360' height='200' viewBox='0 0 360 200'%3E%3Crect width='100%25' height='100%25' fill='%23f0f0f0'/%3E%3Ctext x='50%25' y='50%25' font-family='Arial' font-size='14' fill='%23999' text-anchor='middle' dy='.3em'%3E实时摄像头画面%3C/text%3E%3C/svg%3E" alt="实时画面" />
            <div class="camera-overlay">
              <span id="fps_counter">FPS: --</span>
            </div>
          </div>
          <div class="detection-view">
            <img id="detection_result" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='360' height='200' viewBox='0 0 360 200'%3E%3Crect width='100%25' height='100%25' fill='%23f8f9fa'/%3E%3Ctext x='50%25' y='50%25' font-family='Arial' font-size='14' fill='%23666' text-anchor='middle' dy='.3em'%3E目标检测结果%3C/text%3E%3C/svg%3E" alt="检测结果" />
            <div class="detection-overlay">
              <span id="object_count">对象: 0</span>
            </div>
          </div>
        </div>
        
        <div class="vision-controls">
          <button class="control-btn primary" onclick="runDetection()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="11" cy="11" r="8"/>
              <path d="m21 21-4.35-4.35"/>
            </svg>
            检测物体
          </button>
          <button class="control-btn secondary" onclick="refreshCamera()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M3 3h6l2 3h10a2 2 0 0 1 2 2v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2z"/>
              <circle cx="12" cy="13" r="3"/>
            </svg>
            刷新
          </button>
        </div>

        <div class="objects-list" id="objects_list">
          <div class="empty-state">等待检测...</div>
        </div>
      </div>
    </div>

    <!-- 视觉面板切换按钮 -->
    <button class="vision-toggle-btn" id="vision_toggle_btn" onclick="toggleVisionPanel()">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
        <circle cx="12" cy="12" r="3"/>
      </svg>
    </button>
  </div>

  <!-- 通知容器 -->
  <div id="notifications"></div>

  <script>
    // 全局变量
    let isRecording = false;
    let isVoiceWakeEnabled = false;
    let isTTSEnabled = true;
    let visionPanelOpen = false;
    let voiceWakeListener = null;

    // 初始化
    document.addEventListener('DOMContentLoaded', function() {
      initializeApp();
      autoResizeTextarea();
      connectWebSocket();
      setupVoiceWake();
    });

    function initializeApp() {
      console.log('🤖 AI视觉机械臂控制系统启动中...');
      
      // 模拟状态更新
      setTimeout(() => {
        document.getElementById('system_status').textContent = '系统就绪';
      }, 2000);
    }

    // 切换视觉面板
    function toggleVisionPanel() {
      const panel = document.getElementById('vision_panel');
      const toggleBtn = document.getElementById('vision_toggle_btn');
      const headerBtn = document.querySelector('.header-actions .icon-btn');
      
      visionPanelOpen = !visionPanelOpen;
      
      if (visionPanelOpen) {
        panel.classList.add('open');
        toggleBtn.classList.add('panel-open');
        headerBtn.classList.add('active');
      } else {
        panel.classList.remove('open');
        toggleBtn.classList.remove('panel-open');
        headerBtn.classList.remove('active');
      }
    }

    // 切换AI思考过程
    function toggleThinking(header) {
      const content = header.nextElementSibling;
      const toggle = header.querySelector('.thinking-toggle');
      
      if (content.classList.contains('expanded')) {
        content.classList.remove('expanded');
        toggle.classList.remove('expanded');
      } else {
        content.classList.add('expanded');
        toggle.classList.add('expanded');
      }
    }

    // 切换输入模式
    function switchInputMode(mode) {
      // 更新按钮状态
      document.querySelectorAll('.mode-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      document.querySelector(`[data-mode="${mode}"]`).classList.add('active');
      
      const voiceBtn = document.getElementById('voice_btn');
      const messageInput = document.getElementById('message_input');
      
      if (mode === 'voice') {
        voiceBtn.style.display = 'flex';
        messageInput.placeholder = '点击麦克风录音或开启语音唤醒...';
      } else {
        voiceBtn.style.display = 'none';
        messageInput.placeholder = '请输入您的指令或问题...';
      }
    }

    // 语音唤醒相关功能
    function setupVoiceWake() {
      // 模拟语音唤醒检测
      if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
        console.log('🎤 语音识别API可用');
      } else {
        console.log('❌ 浏览器不支持语音识别');
      }
    }

    function toggleVoiceWake() {
      const toggle = document.getElementById('voice_wake_toggle');
      const indicator = document.getElementById('voice_wake_indicator');
      
      isVoiceWakeEnabled = !isVoiceWakeEnabled;
      
      if (isVoiceWakeEnabled) {
        toggle.classList.add('active');
        indicator.classList.add('active');
        startVoiceWakeListening();
        showNotification('语音唤醒已开启', 'success');
      } else {
        toggle.classList.remove('active');
        indicator.classList.remove('active');
        stopVoiceWakeListening();
        showNotification('语音唤醒已关闭', 'info');
      }
    }

    function startVoiceWakeListening() {
      // 这里应该实现实际的语音唤醒监听逻辑
      console.log('🎤 开始语音唤醒监听...');
      
      // 模拟语音唤醒触发
      setTimeout(() => {
        if (isVoiceWakeEnabled) {
          simulateVoiceWakeActivation();
        }
      }, 5000);
    }

    function stopVoiceWakeListening() {
      console.log('🛑 停止语音唤醒监听');
      if (voiceWakeListener) {
        // 停止监听
      }
    }

    function simulateVoiceWakeActivation() {
      showNotification('检测到唤醒词！', 'success');
      startVoiceRecording();
    }

    function toggleTTS() {
      const toggle = document.getElementById('tts_toggle');
      isTTSEnabled = !isTTSEnabled;
      
      if (isTTSEnabled) {
        toggle.classList.add('active');
        showNotification('语音播放已开启', 'success');
      } else {
        toggle.classList.remove('active');
        showNotification('语音播放已关闭', 'info');
      }
    }

    // 语音录音功能
    function toggleVoiceRecording() {
      if (isRecording) {
        stopVoiceRecording();
      } else {
        startVoiceRecording();
      }
    }

    function startVoiceRecording() {
      isRecording = true;
      const voiceBtn = document.getElementById('voice_btn');
      const audioStatus = document.getElementById('audio_status');
      
      voiceBtn.classList.add('recording');
      voiceBtn.innerHTML = `
        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
          <rect x="6" y="6" width="12" height="12" rx="2"/>
        </svg>
      `;
      voiceBtn.title = '点击停止录音';
      
      audioStatus.textContent = '正在录音...';
      audioStatus.classList.add('visible');
      
      // 模拟录音过程（实际应该调用Web Speech API）
      setTimeout(() => {
        if (isRecording) {
          stopVoiceRecording();
        }
      }, 5000); // 5秒后自动停止
    }

    function stopVoiceRecording() {
      isRecording = false;
      const voiceBtn = document.getElementById('voice_btn');
      const audioStatus = document.getElementById('audio_status');
      const messageInput = document.getElementById('message_input');
      
      voiceBtn.classList.remove('recording');
      voiceBtn.classList.add('listening');
      voiceBtn.innerHTML = `
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
          <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
          <line x1="12" y1="19" x2="12" y2="23"/>
          <line x1="8" y1="23" x2="16" y2="23"/>
        </svg>
      `;
      voiceBtn.title = '点击录音';
      
      audioStatus.textContent = '正在识别...';
      
      // 模拟语音识别
      setTimeout(() => {
        const recognizedText = '请帮我检测桌面上的物体';
        messageInput.value = recognizedText;
        
        audioStatus.textContent = '识别完成';
        voiceBtn.classList.remove('listening');
        
        setTimeout(() => {
          audioStatus.classList.remove('visible');
        }, 2000);
        
        // 自动发送消息
        setTimeout(() => {
          sendMessage();
        }, 1000);
      }, 2000);
    }

    // 发送消息
    function sendMessage() {
      const input = document.getElementById('message_input');
      const message = input.value.trim();
      
      if (!message) return;

      // 添加用户消息
      addMessage('user', message);
      
      // 清空输入
      input.value = '';
      
      // 自动调整高度
      input.style.height = 'auto';
      
      // 模拟AI响应
      setTimeout(() => {
        addAIResponse(message);
      }, 1000);
    }

    // 添加消息到聊天区域
    function addMessage(type, content) {
      const messagesContainer = document.getElementById('chat_messages');
      
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${type}`;
      
      const messageContent = document.createElement('div');
      messageContent.className = 'message-content';
      messageContent.textContent = content;
      
      messageDiv.appendChild(messageContent);
      messagesContainer.appendChild(messageDiv);
      
      // 滚动到底部
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    // 添加AI响应（包含思考过程）
    function addAIResponse(userMessage) {
      const messagesContainer = document.getElementById('chat_messages');
      
      const messageDiv = document.createElement('div');
      messageDiv.className = 'message assistant';
      
      const messageContent = document.createElement('div');
      messageContent.className = 'message-content';
      
      // 生成响应内容
      const response = generateAIResponse(userMessage);
      messageContent.innerHTML = response;
      
      messageDiv.appendChild(messageContent);
      messagesContainer.appendChild(messageDiv);
      
      // 滚动到底部
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
      
      // 如果启用了TTS，播放语音
      if (isTTSEnabled) {
        playTTS(generateMainResponse(userMessage));
      }
    }

    // 生成AI响应（包含思考过程）
    function generateAIResponse(userMessage) {
      const thinking = generateThinkingProcess(userMessage);
      const response = generateMainResponse(userMessage);
      
      return `
        ${response}
        
        <div class="thinking-section">
          <div class="thinking-header" onclick="toggleThinking(this)">
            <div class="thinking-title">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 12l2 2 4-4"/>
                <path d="M21 12c0 4.97-4.03 9-9 9s-9-4.03-9-9 9 4.03 9 9z"/>
              </svg>
              <span>AI思考过程</span>
            </div>
            <svg class="thinking-toggle" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="m6 9 6 6 6-6"/>
            </svg>
          </div>
          <div class="thinking-content">
            <div class="thinking-text">${thinking}</div>
          </div>
        </div>
      `;
    }

    // 生成思考过程
    function generateThinkingProcess(userMessage) {
      if (userMessage.includes('抓取') || userMessage.includes('拿')) {
        return `用户要求执行抓取动作。我需要：

1. 启动视觉系统确认目标物体
2. 分析物体的位置和特征
3. 计算最优抓取路径
4. 检查机械臂状态和可达性
5. 规划夹爪开合角度
6. 执行抓取序列

让我先通过视觉系统分析当前场景...`;
      } else if (userMessage.includes('检测') || userMessage.includes('看')) {
        return `用户要求进行视觉检测。我的分析流程：

1. 激活摄像头获取实时画面
2. 运行物体检测算法
3. 识别和分类场景中的物体
4. 分析物体的位置坐标和特征
5. 生成检测结果报告

正在处理视觉数据...`;
      } else if (userMessage.includes('停止') || userMessage.includes('紧急')) {
        return `检测到紧急停止指令！

1. 立即停止所有机械臂运动
2. 锁定当前位置
3. 切断动力输出
4. 等待进一步指令

安全是第一优先级，正在执行紧急停止...`;
      } else {
        return `分析用户意图："${userMessage}"

这是一个一般性询问，我需要：
1. 理解用户的具体需求
2. 确定是否需要启用特定功能
3. 提供相应的帮助和建议
4. 如果涉及机械臂操作，准备相关流程

根据当前上下文生成回应...`;
      }
    }

    // 生成主要响应
    function generateMainResponse(userMessage) {
      if (userMessage.includes('抓取') || userMessage.includes('拿')) {
        return '我理解您要执行抓取操作。正在启动视觉系统进行场景分析，请稍候...';
      } else if (userMessage.includes('检测') || userMessage.includes('看')) {
        return '正在启动物体检测功能，分析摄像头画面中的物体...';
      } else if (userMessage.includes('状态') || userMessage.includes('情况')) {
        return '当前系统状态良好，所有服务运行正常。如需检查特定组件状态，请告诉我具体需求。';
      } else if (userMessage.includes('停止') || userMessage.includes('紧急')) {
        return '⚠️ 紧急停止指令已执行！机械臂已停止所有运动并锁定位置。';
      } else if (userMessage.includes('返回') || userMessage.includes('原点')) {
        return '正在规划返回原点路径，机械臂将安全移动到初始位置...';
      } else {
        return '我是您的AI视觉机械臂助手。我可以帮您控制机械臂、分析视觉画面、检测物体等。请告诉我您需要什么帮助？';
      }
    }

    // TTS播放
    function playTTS(text) {
      if ('speechSynthesis' in window) {
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'zh-CN';
        utterance.rate = 0.9;
        utterance.pitch = 1.0;
        speechSynthesis.speak(utterance);
      }
    }

    // 视觉功能
    function runDetection() {
      showNotification('正在运行物体检测...', 'info');
      document.getElementById('object_count').textContent = '对象: 3';
      
      setTimeout(() => {
        document.getElementById('objects_list').innerHTML = `
          <div style="margin-bottom: 10px; padding: 8px; background: rgba(0,0,0,0.05); border-radius: 6px;">
            📱 手机 (置信度: 95%)
          </div>
          <div style="margin-bottom: 10px; padding: 8px; background: rgba(0,0,0,0.05); border-radius: 6px;">
            🍎 苹果 (置信度: 87%)
          </div>
          <div style="margin-bottom: 10px; padding: 8px; background: rgba(0,0,0,0.05); border-radius: 6px;">
            📚 书本 (置信度: 92%)
          </div>
        `;
      }, 2000);
    }

    function refreshCamera() {
      showNotification('刷新摄像头...', 'info');
      document.getElementById('fps_counter').textContent = 'FPS: 30';
    }

    // 自动调整文本域高度
    function autoResizeTextarea() {
      const textarea = document.getElementById('message_input');
      textarea.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 120) + 'px';
      });
      
      textarea.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });
    }

    // WebSocket连接（模拟）
    function connectWebSocket() {
      console.log('🔌 连接到后端服务...');
      // 这里应该是实际的WebSocket连接逻辑
    }

    // 通知功能
    function showNotification(message, type = 'info') {
      const container = document.getElementById('notifications');
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.textContent = message;
      
      container.appendChild(notification);
      
      setTimeout(() => {
        notification.remove();
      }, 3000);
    }

    // 执行确认
    function confirmExecution() {
      showNotification('正在执行动作...', 'success');
      document.getElementById('execution_panel').style.display = 'none';
    }

    function cancelExecution() {
      showNotification('已取消执行', 'warning');
      document.getElementById('execution_panel').style.display = 'none';
    }
  </script>
</body>
</html>